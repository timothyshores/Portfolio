---
title: "Using Sessions and Cookies üç™ using express-session"
date: "2019-05-07"
---

![Using Sessions and Cookies](https://i.imgur.com/C9fzky3.png)

<center>

*Image by [Ice Cream Sandwich Comics](https://icecreamsandwichcomics.com/post/157923361474/you-are-only-making-him-more-powerful-full-image "Ice Cream Sandwich Comics")* 

</center>


---

*Sessions and Cookies üç™ are like a room key üîë  to a hotel room üè®.* 

*Cookies üç™ get passed back and forth üîÑ between the client and server like watching a tennis ball üéæ in a game of tennis.*

**Initial Repo: https://github.com/LambdaSchool/webauth-ii-guided**

1. Run `yarn add express-session`
2. Import express-session into `server.js`
`const session = require('express-session')`
3. Create a new sessionConfig variable and configure middleware to use session and sessionConfig in `server.js`

```javascript
const sessionConfig = {
    name: '', // default value is session id
    secret: 'keep it secret, keep it safe - gandalf', // only our server knows this value for production store this in .env file
    cookie: {
        httpOnly: true, // true prevents access from Javascript console in the user's browser
        maxAge: 1000 * 60 * 10, // value in miliseconds so 1000 * 60 * 10 is ten minutes
        secure: false, // false allows cookies to be sent over http and true allows cookies to be sent over https
    },
    resave: false, // false prevents a cookie from automatically being generated by the server for General Data Protection Regulation (GDPR) regulations in Europe
    saveUninitialized: true, // create new session automatically, display to client that the website stores cookies
};

server.use(session(sessionConfig));
```

4. Create a cookie in the POST request endpoint to /api/auth/login in `auth/auth-router.js` 

```javascript
router.post('/login', (req, res) => {
    let { username, password } = req.body;

    Users.findBy({ username })
        .first()
        .then(user => {
            if (user && bcrypt.compareSync(password, user.password)) {
                req.session.username = user.username; 
                res.status(200).json({
                    message: `Welcome ${user.username}!`,
                });
            } else {
                res.status(401).json({ message: 'Invalid Credentials' });
            }
        })
        .catch(error => {
            res.status(500).json(error);
        });
});
```

5. Send a POST request to `localhost:5000/api/auth/register` in Insomnia

```javascript
{
	"username": "admin",
	"password": "admin"
}
```

This will return the id, username and hashed password

```javascript
{
  "id": 1,
  "username": "admin",
  "password": "$10$ydo4X4yZYPvKvf8e077W.kczte6iU.WGTtkmBURihS0"
}
```

6. Refactor `auth/restricted-middleware.js` to check for cookies

```javascript
module.exports = (req, res, next) => {
    if (req.session && req.session.username) {
        next();
    }
    else {
        res.status(401).json({ message: 'Please login to continue' });
    }
};
```

7. Create a GET request endpoint to `localhost:5000/api/auth/logout`

```javascript
router.get('/logout', (req, res) => {
    if (req.session) {
        req.session.destroy(err => {
            err ? res.send('Error logging out') : res.send('Logging out');
        });
    } else {
        res.send('Already logged out');
    }
});
```

**Final Repo: https://github.com/timothyshores/webauth-ii-guided**